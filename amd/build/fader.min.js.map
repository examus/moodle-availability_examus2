{"version":3,"file":"fader.min.js","sources":["../src/fader.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Availability plugin for integration with Examus.\n *\n * @module     availability_examus2/fader\n * @copyright  2019-2023 Maksim Burnin <maksim.burnin@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/str', 'core/notification'], function(str, notification) {\n    return {\n        init: function(formData, reset) {\n            const TAG = 'proctoring fader';\n            const expectedData = 'proctoringReady_n6EY';\n\n            //Promise, which resolves when got a message proving the page is being examus2ed.\n            const waitForProof = () => new Promise(resolve => {\n                const messageHandler = e => {\n                    /* eslint-disable no-console */\n                    console.debug(TAG, 'got some message', e.data);\n                    /* eslint-enable no-console */\n\n                    if (expectedData === e.data) {\n                      resolve();\n                      /* eslint-disable no-console */\n                      console.debug(TAG, 'got proving message', e.data);\n                      /* eslint-enable no-console */\n                      window.removeEventListener('message', messageHandler);\n                    }\n                };\n\n                window.addEventListener(\"message\", messageHandler);\n            });\n\n            //Prepare the element to cover quiz contents.\n            const createFader = (html) => {\n                const fader = document.createElement(\"div\");\n\n                fader.innerHTML = html;\n\n                Object.assign(fader.style, {\n                    position: 'fixed',\n                    zIndex: 1000,\n                    fontSize: '2em',\n                    width: '100%',\n                    height: '100%',\n                    background: '#fff',\n                    top: 0,\n                    left: 0,\n                    textAlign: 'center',\n                    display: 'flex',\n                    justifyContent: 'center',\n                    alignContent: 'center',\n                    flexDirection: 'column',\n                });\n\n                document.body.appendChild(fader);\n\n                return fader;\n            };\n\n            const redirectToExamus = () => {\n                if (!formData) {\n                    return;\n                }\n                const form = document.createElement(\"form\");\n                const input = document.createElement(\"input\");\n                form.appendChild(input);\n                document.body.appendChild(form);\n\n                form.method = formData['method'];\n                form.action = formData['action'];\n                input.name = \"token\";\n                input.value = formData['token'];\n                form.submit();\n            };\n\n            //Run.\n\n            //Prepare to catch the message early.\n            const proved = waitForProof();\n\n            str.get_strings([\n                {'key' : 'fader_awaiting_proctoring', 'component' : 'availability_examus2'},\n                {'key' : 'fader_instructions', 'component' : 'availability_examus2'},\n                {'key' : 'fader_reset', 'component' : 'availability_examus2'},\n            ]).done(function(s) {\n                const faderHTML = s[0] + s[1];\n                const strReset = s[2];\n                const fader = createFader(faderHTML);\n                const redirectTimeout = setTimeout(() => {\n                    redirectToExamus();\n                }, 15000);\n                proved.then(() => {\n                    if (reset) {\n                        fader.innerHTML = strReset;\n                    } else {\n                        fader.remove();\n                    }\n                    clearTimeout(redirectTimeout);\n                });\n            }).fail(notification.exception);\n        }\n    };\n});"],"names":["define","str","notification","init","formData","reset","TAG","proved","Promise","resolve","messageHandler","e","console","debug","data","window","removeEventListener","addEventListener","get_strings","done","s","faderHTML","strReset","fader","html","document","createElement","innerHTML","Object","assign","style","position","zIndex","fontSize","width","height","background","top","left","textAlign","display","justifyContent","alignContent","flexDirection","body","appendChild","createFader","redirectTimeout","setTimeout","form","input","method","action","name","value","submit","redirectToExamus","then","remove","clearTimeout","fail","exception"],"mappings":";;;;;;;AAuBAA,oCAAO,CAAC,WAAY,sBAAsB,SAASC,IAAKC,oBAC7C,CACHC,KAAM,SAASC,SAAUC,aACfC,IAAM,mBAoENC,OAhEqB,IAAIC,SAAQC,gBAC7BC,eAAiBC,IAEnBC,QAAQC,MAAMP,IAAK,mBAAoBK,EAAEG,MAN5B,yBASQH,EAAEG,OACrBL,UAEAG,QAAQC,MAAMP,IAAK,sBAAuBK,EAAEG,MAE5CC,OAAOC,oBAAoB,UAAWN,kBAI5CK,OAAOE,iBAAiB,UAAWP,mBAmDvCT,IAAIiB,YAAY,CACZ,KAAS,sCAA2C,wBACpD,KAAS,+BAAoC,wBAC7C,KAAS,wBAA6B,0BACvCC,MAAK,SAASC,SACPC,UAAYD,EAAE,GAAKA,EAAE,GACrBE,SAAWF,EAAE,GACbG,MAtDWC,CAAAA,aACXD,MAAQE,SAASC,cAAc,cAErCH,MAAMI,UAAYH,KAElBI,OAAOC,OAAON,MAAMO,MAAO,CACvBC,SAAU,QACVC,OAAQ,IACRC,SAAU,MACVC,MAAO,OACPC,OAAQ,OACRC,WAAY,OACZC,IAAK,EACLC,KAAM,EACNC,UAAW,SACXC,QAAS,OACTC,eAAgB,SAChBC,aAAc,SACdC,cAAe,WAGnBlB,SAASmB,KAAKC,YAAYtB,OAEnBA,OA+BOuB,CAAYzB,WACpB0B,gBAAkBC,YAAW,KA7Bd,UAChB5C,sBAGC6C,KAAOxB,SAASC,cAAc,QAC9BwB,MAAQzB,SAASC,cAAc,SACrCuB,KAAKJ,YAAYK,OACjBzB,SAASmB,KAAKC,YAAYI,MAE1BA,KAAKE,OAAS/C,SAAQ,OACtB6C,KAAKG,OAAShD,SAAQ,OACtB8C,MAAMG,KAAO,QACbH,MAAMI,MAAQlD,SAAQ,MACtB6C,KAAKM,UAiBDC,KACD,MACHjD,OAAOkD,MAAK,KACJpD,MACAkB,MAAMI,UAAYL,SAElBC,MAAMmC,SAEVC,aAAaZ,uBAElBa,KAAK1D,aAAa2D"}